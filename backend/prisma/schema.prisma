// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// ---------- USER ----------
model User {
  id                    String   @id @default(uuid())
  name                  String
  email                 String   @unique
  passwordHash          String   @map("password_hash")
  skillLevel            String   @default("beginner") @map("skill_level")
  currentLanguage       String?  @default("English") @map("current_language")
  totalPoints           Int      @default(0) @map("total_points")
  streakDays            Int      @default(0) @map("streak_days")
  background            String?  // User's educational/professional background
  goals                 String?  // User's learning goals
  learningInterests     String?  @map("learning_interests") // What user wants to learn (comma-separated)
  onboardingStep        String   @default("AUTH_EMAIL") @map("onboarding_step") // AUTH_EMAIL, AUTH_PASSWORD, AUTH_SIGNUP_PASSWORD, ASK_NAME, ASK_INTERESTS, ASK_GOALS, ASK_EDUCATION, COMPLETE
  failedLoginAttempts   Int      @default(0) @map("failed_login_attempts")
  lockedUntil           DateTime? @map("locked_until")
  onboardingAttempts    Int      @default(0) @map("onboarding_attempts")
  onboardingLockedUntil DateTime? @map("onboarding_locked_until")
  hasCompletedOnboarding Boolean @default(false) @map("has_completed_onboarding")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relationships
  userTopics   UserTopic[]
  progress     Progress[]
  submissions  Submission[]
  chatSessions ChatSession[]
  userBadges   UserBadge[]
  aiLogs       AILog[]

  @@map("users")
}

// ---------- MASTER TOPICS (Predefined topics available to all users) ----------
model MasterTopic {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  iconUrl     String?  @map("icon_url")
  category    String?  // e.g., "Programming Language", "Framework", "Library"
  isActive    Boolean  @default(true) @map("is_active")
  orderIndex  Int?     @default(0) @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  userTopics   UserTopic[]
  subtopics    Subtopic[]

  @@map("master_topics")
}

// ---------- USER TOPICS (User's enrolled topics) ----------
model UserTopic {
  id               Int      @id @default(autoincrement())
  userId           String   @map("user_id")
  masterTopicId    Int      @map("master_topic_id")
  enrolledAt       DateTime @default(now()) @map("enrolled_at")
  lastAccessedAt   DateTime @default(now()) @map("last_accessed_at")
  completedPercent Float    @default(0.0) @map("completed_percent")
  isActive         Boolean  @default(true) @map("is_active")

  // Relationships
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  masterTopic  MasterTopic  @relation(fields: [masterTopicId], references: [id], onDelete: Cascade)
  progress     Progress[]
  chatSessions ChatSession[]

  @@unique([userId, masterTopicId])
  @@map("user_topics")
}

// ---------- SUBTOPICS ----------
model Subtopic {
  id              Int      @id @default(autoincrement())
  masterTopicId   Int      @map("master_topic_id")
  title           String
  description     String?
  difficultyLevel String   @default("basic") @map("difficulty_level") // basic, intermediate, advanced
  orderIndex      Int?     @map("order_index")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relationships
  masterTopic  MasterTopic   @relation(fields: [masterTopicId], references: [id], onDelete: Cascade)
  exercises    Exercise[]
  progress     Progress[]
  chatSessions ChatSession[]

  @@map("subtopics")
}

// ---------- EXERCISES ----------
model Exercise {
  id          Int      @id @default(autoincrement())
  subtopicId  Int      @map("subtopic_id")
  title       String
  prompt      String
  starterCode String?  @map("starter_code")
  difficulty  String   @default("basic")
  aiGenerated Boolean  @default(true) @map("ai_generated")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relationships
  subtopic     Subtopic      @relation(fields: [subtopicId], references: [id], onDelete: Cascade)
  testCases    TestCase[]
  submissions  Submission[]
  chatMessages ChatMessage[]

  @@map("exercises")
}

// ---------- TEST CASES ----------
model TestCase {
  id             Int     @id @default(autoincrement())
  exerciseId     Int     @map("exercise_id")
  input          Json
  expectedOutput Json    @map("expected_output")
  visible        Boolean @default(false)

  // Relationships
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("test_cases")
}

// ---------- SUBMISSIONS ----------
model Submission {
  id         Int      @id @default(autoincrement())
  userId     String   @map("user_id")
  exerciseId Int      @map("exercise_id")
  code       String
  status     String   @default("failed")
  score      Int      @default(0)
  feedback   String?
  runtime    Float?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relationships
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("submissions")
}

// ---------- PROGRESS ----------
model Progress {
  id               Int      @id @default(autoincrement())
  userId           String   @map("user_id")
  userTopicId      Int      @map("user_topic_id")
  subtopicId       Int?     @map("subtopic_id")
  completedPercent Float    @default(0.0) @map("completed_percent")
  lastExerciseId   Int?     @map("last_exercise_id")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relationships
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userTopic UserTopic  @relation(fields: [userTopicId], references: [id], onDelete: Cascade)
  subtopic  Subtopic?  @relation(fields: [subtopicId], references: [id], onDelete: SetNull)

  @@unique([userId, userTopicId, subtopicId])
  @@map("progress")
}

// ---------- BADGES ----------
model Badge {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  criteria    Json?
  iconUrl     String? @map("icon_url")

  // Relationships
  userBadges UserBadge[]

  @@map("badges")
}

// ---------- USER BADGES ----------
model UserBadge {
  id       Int      @id @default(autoincrement())
  userId   String   @map("user_id")
  badgeId  Int      @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  // Relationships
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@map("user_badges")
}

// ---------- CHAT SESSIONS ----------
model ChatSession {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  userTopicId       Int      @map("user_topic_id")
  subtopicId        Int?     @map("subtopic_id")
  title             String
  startedAt         DateTime @default(now()) @map("started_at")
  lastActivity      DateTime @default(now()) @map("last_activity")
  completionPercent Float    @default(0.0) @map("completion_percent")
  aiSummary         String?  @map("ai_summary")
  difficultyLevel   String   @default("basic") @map("difficulty_level")

  // Relationships
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userTopic UserTopic     @relation(fields: [userTopicId], references: [id], onDelete: Cascade)
  subtopic  Subtopic?     @relation(fields: [subtopicId], references: [id], onDelete: SetNull)
  messages  ChatMessage[]

  @@map("chat_sessions")
}

// ---------- CHAT MESSAGES ----------
model ChatMessage {
  id           Int      @id @default(autoincrement())
  chatId       String   @map("chat_id")
  userId       String?  @map("user_id")
  role         String   @default("user")
  messageType  String   @default("text") @map("message_type")
  content      String
  codeSnippet  String?  @map("code_snippet")
  exerciseId   Int?     @map("exercise_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relationships
  chat     ChatSession @relation(fields: [chatId], references: [id], onDelete: Cascade)
  exercise Exercise?   @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  @@map("chat_messages")
}

// ---------- AI LOGS ----------
model AILog {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id")
  exerciseId  Int?     @map("exercise_id")
  inputPrompt String   @map("input_prompt")
  aiResponse  String?  @map("ai_response")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_logs")
}
